import streamlit as st
import google.generativeai as genai
import os
import tempfile

# 1. ÿ•ÿπÿØÿßÿØ ÿßŸÑÿµŸÅÿ≠ÿ©
st.set_page_config(page_title="Medical Transcriber", page_icon="ü©∫")
st.title("ü©∫ Medical Lecture Transcriber")
st.caption("Powered by Gemini 1.5 Pro | Egy-English Hybrid")

# 2. ŸÖŸÉÿßŸÜ Ÿàÿ∂ÿπ ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸÄ API
# (ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ÿ≥ŸÜÿ∂ÿπŸá ŸÅŸä ŸÖŸÉÿßŸÜ ÿ¢ŸÖŸÜÿå ŸÑŸÉŸÜ ŸÑŸÑÿ≥ŸáŸàŸÑÿ© ÿ∂ÿπŸá ŸáŸÜÿß ÿ£Ÿà ŸÅŸä ÿßŸÑÿÆÿßŸÜÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©)
api_key = st.sidebar.text_input("Enter Gemini API Key", type="password")

if api_key:
    genai.configure(api_key=api_key)

        # 3. ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ
            uploaded_file = st.file_uploader("Upload Lecture (Audio)", type=["mp3", "wav", "m4a", "ogg"])

                if uploaded_file is not None:
                        st.audio(uploaded_file)
                                
                                        if st.button("Transcribe Now üöÄ"):
                                                    with st.spinner('Dr. Gemini is listening... Please wait...'):
                                                                    try:
                                                                                        # ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ŸÖÿ§ŸÇÿ™ÿßŸã ŸÑŸÑŸÖÿπÿßŸÑÿ¨ÿ©
                                                                                                            with tempfile.NamedTemporaryFile(delete=False, suffix='.mp3') as tmp_file:
                                                                                                                                    tmp_file.write(uploaded_file.getvalue())
                                                                                                                                                            tmp_file_path = tmp_file.name

                                                                                                                                                                                # ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ŸÑŸÄ Gemini
                                                                                                                                                                                                    myfile = genai.upload_file(tmp_file_path)
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                            # ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸàÿØŸäŸÑ
                                                                                                                                                                                                                                                                model = genai.GenerativeModel("gemini-1.5-pro")

                                                                                                                                                                                                                                                                                    # ÿßŸÑÿ£ŸÖÿ± ÿßŸÑÿ∑ÿ®Ÿä (ÿßŸÑÿ®ÿ±ŸàŸÖÿ®ÿ™)
                                                                                                                                                                                                                                                                                                        prompt = """
                                                                                                                                                                                                                                                                                                                            Act as a professional Medical Transcriptionist.
                                                                                                                                                                                                                                                                                                                                                Transcribe the attached audio file verbatim (word-for-word).
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                        Rules:
                                                                                                                                                                                                                                                                                                                                                                                                            1. Keep the mixed language (Egyptian Arabic + English).
                                                                                                                                                                                                                                                                                                                                                                                                                                2. Write Egyptian Arabic in Arabic script.
                                                                                                                                                                                                                                                                                                                                                                                                                                                    3. CRITICAL: Write ALL medical terms, diseases, and drugs in English with correct medical spelling.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        4. Do not summarize. Do not translate medical terms to Arabic.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            5. Format as a clean, readable script.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = model.generate_content([uploaded_file, prompt])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    st.success("Done!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        st.markdown("### Transcript:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.text_area("Copy your text:", value=response.text, height=400)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ§ŸÇÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        os.unlink(tmp_file_path)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            st.error(f"Error: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                st.warning("Please enter your API Key in the sidebar to start.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                